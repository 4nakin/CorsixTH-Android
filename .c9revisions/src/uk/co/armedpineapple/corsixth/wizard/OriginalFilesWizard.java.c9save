{"ts":1354184093258,"silentsave":true,"restoring":false,"patch":[[{"diffs":[[1,"/*\n *   Copyright (C) 2012 Alan Woolley\n *   \n *   See LICENSE.TXT for full license\n */\npackage uk.co.armedpineapple.corsixth.wizard;\n\nimport java.io.File;\n\nimport com.bugsense.trace.BugSenseHandler;\n\nimport uk.co.armedpineapple.corsixth.AsyncTaskResult;\nimport uk.co.armedpineapple.corsixth.Configuration;\nimport uk.co.armedpineapple.corsixth.ConfigurationException;\nimport uk.co.armedpineapple.corsixth.Files;\nimport uk.co.armedpineapple.corsixth.Files.FindFilesTask;\nimport uk.co.armedpineapple.corsixth.Network;\nimport uk.co.armedpineapple.corsixth.R;\nimport uk.co.armedpineapple.corsixth.Files.DownloadFileTask;\nimport uk.co.armedpineapple.corsixth.Files.UnzipTask;\nimport uk.co.armedpineapple.corsixth.dialogs.DialogFactory;\nimport android.app.AlertDialog;\nimport android.app.Dialog;\nimport android.app.ProgressDialog;\nimport android.app.AlertDialog.Builder;\nimport android.content.Context;\nimport android.content.DialogInterface;\nimport android.util.AttributeSet;\nimport android.util.Log;\nimport android.view.View;\nimport android.widget.EditText;\nimport android.widget.RadioButton;\nimport android.widget.RadioGroup;\nimport android.widget.Toast;\n\npublic class OriginalFilesWizard extends WizardView {\n\n\tRadioGroup originalFilesRadioGroup;\n\tRadioButton automaticRadio;\n\tRadioButton manualRadio;\n\tRadioButton downloadDemoRadio;\n\n\tString customLocation;\n\n\tContext ctx;\n\n\tpublic OriginalFilesWizard(Context context, AttributeSet attrs, int defStyle) {\n\t\tsuper(context, attrs, defStyle);\n\t\tctx = context;\n\t}\n\n\tpublic OriginalFilesWizard(Context context, AttributeSet attrs) {\n\t\tsuper(context, attrs);\n\t\tctx = context;\n\t}\n\n\tpublic OriginalFilesWizard(Context context) {\n\t\tsuper(context);\n\t\tctx = context;\n\t}\n\n\t@Override\n\tvoid saveConfiguration(Configuration config) throws ConfigurationException {\n\t\tif (!Files.hasDataFiles(customLocation)) {\n\n\t\t\t// Check to see if there's a HOSP directory instead\n\n\t\t\tFile hosp = new File(config.getOriginalFilesPath() + \"/HOSP\");\n\t\t\tif (hosp.exists()\n\t\t\t\t\t&& Files.hasDataFiles(config.getOriginalFilesPath()\n\t\t\t\t\t\t\t+ \"/HOSP\")) {\n\t\t\t\tmanualRadio.setChecked(true);\n\t\t\t\tcustomLocation = config.getOriginalFilesPath() + \"/HOSP\";\n\t\t\t\tconfig.setOriginalFilesPath(customLocation);\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tAlertDialog.Builder builder = new AlertDialog.Builder(ctx);\n\n\t\t\tbuilder.setMessage(ctx.getString(R.string.no_data_dialog))\n\t\t\t\t\t.setCancelable(true)\n\t\t\t\t\t.setNeutralButton(R.string.ok,\n\t\t\t\t\t\t\tnew DialogInterface.OnClickListener() {\n\n\t\t\t\t\t\t\t\t@Override\n\t\t\t\t\t\t\t\tpublic void onClick(DialogInterface dialog,\n\t\t\t\t\t\t\t\t\t\tint which) {\n\t\t\t\t\t\t\t\t\tdialog.dismiss();\n\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t});\n\n\t\t\tAlertDialog alert = builder.create();\n\t\t\talert.show();\n\n\t\t\tthrow new ConfigurationException();\n\t\t}\n\t\tconfig.setOriginalFilesPath(customLocation);\n\n\t}\n\n\t@Override\n\tvoid loadConfiguration(Configuration config) {\n\n\t\toriginalFilesRadioGroup = ((RadioGroup) findViewById(R.id.originalFilesRadioGroup));\n\t\tautomaticRadio = ((RadioButton) findViewById(R.id.automaticRadio));\n\t\tmanualRadio = ((RadioButton) findViewById(R.id.manualRadio));\n\t\tdownloadDemoRadio = ((RadioButton) findViewById(R.id.downloadDemoRadio));\n\n\t\tfinal EditText editTextBox = new EditText(ctx);\n\t\teditTextBox.setText(Files.getExtStoragePath() + \"th\");\n\t\tBuilder builder = new Builder(ctx);\n\t\tbuilder.setMessage(R.string.custom_location_message);\n\t\tbuilder.setNeutralButton(R.string.ok, new DialogInterface.OnClickListener() {\n\n\t\t\t@Override\n\t\t\tpublic void onClick(DialogInterface dialog, int which) {\n\t\t\t\tcustomLocation = editTextBox.getText().toString();\n\t\t\t\tmanualRadio.setText(\"Custom (\" + customLocation + \")\");\n\t\t\t}\n\t\t});\n\n\t\tbuilder.setView(editTextBox);\n\n\t\tfinal AlertDialog d = builder.create();\n\n\t\tautomaticRadio.setOnClickListener(new View.OnClickListener() {\n\n\t\t\t@Override\n\t\t\tpublic void onClick(View v) {\n\t\t\t\tdoGameFilesSearch();\n\t\t\t}\n\n\t\t});\n\n\t\tmanualRadio.setOnClickListener(new View.OnClickListener() {\n\n\t\t\t@Override\n\t\t\tpublic void onClick(View v) {\n\t\t\t\td.show();\n\t\t\t}\n\t\t});\n\n\t\tautomaticRadio.setChecked(false);\n\t\tdownloadDemoRadio.setChecked(false);\n\t\tif (config.getOriginalFilesPath() != null\n\t\t\t\t&& config.getOriginalFilesPath().length() > 0) {\n\t\t\tmanualRadio.setChecked(true);\n\t\t}\n\n\t\tdownloadDemoRadio.setOnClickListener(new OnClickListener() {\n\n\t\t\t@Override\n\t\t\tpublic void onClick(View v) {\n\t\t\t\tif (!Files.canAccessExternalStorage()) {\n\t\t\t\t\t// Show an error message or something here.\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tFile f = new File(ctx.getExternalFilesDir(null)\n\t\t\t\t\t\t.getAbsolutePath() + \"/demo/HOSP\");\n\t\t\t\tif (!f.exists()) {\n\n\t\t\t\t\tAlertDialog.Builder builder = new AlertDialog.Builder(ctx);\n\t\t\t\t\tDialogInterface.OnClickListener alertListener = new DialogInterface.OnClickListener() {\n\n\t\t\t\t\t\t@Override\n\t\t\t\t\t\tpublic void onClick(DialogInterface dialog, int which) {\n\t\t\t\t\t\t\tif (which == DialogInterface.BUTTON_POSITIVE) {\n\n\t\t\t\t\t\t\t\tdoDemoDownload();\n\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\tdownloadDemoRadio.setChecked(false);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\n\t\t\t\t\t};\n\n\t\t\t\t\tbuilder.setMessage(\n\t\t\t\t\t\t\tgetResources().getString(\n\t\t\t\t\t\t\t\t\tR.string.download_demo_dialog))\n\t\t\t\t\t\t\t.setCancelable(true)\n\t\t\t\t\t\t\t.setNegativeButton(\"Cancel\", alertListener)\n\t\t\t\t\t\t\t.setPositiveButton(\"OK\", alertListener);\n\n\t\t\t\t\tAlertDialog alert = builder.create();\n\t\t\t\t\talert.show();\n\t\t\t\t} else {\n\t\t\t\t\tcustomLocation = ctx.getExternalFilesDir(null)\n\t\t\t\t\t\t\t.getAbsolutePath() + \"/demo/HOSP\";\n\t\t\t\t}\n\t\t\t}\n\n\t\t});\n\t}\n\n\tvoid doDemoDownload() {\n\t\t// Check that the external storage is mounted.\n\t\tif (!Files.canAccessExternalStorage()) {\n\t\t\t// External storage error\n\t\t\tToast toast = Toast.makeText(ctx, R.string.no_external_storage,\n\t\t\t\t\tToast.LENGTH_LONG);\n\t\t\ttoast.show();\n\t\t\treturn;\n\t\t}\n\n\t\t// Check that there is an active network connection\n\t\tif (!Network.HasNetworkConnection(ctx)) {\n\t\t\t// Connection error\n\t\t\tDialog connectionDialog = DialogFactory.createNetworkDialog(ctx);\n\t\t\tconnectionDialog.show();\n\t\t\treturn;\n\t\t}\n\n\t\tfinal File extDir = ctx.getExternalFilesDir(null);\n\t\tfinal ProgressDialog dialog = new ProgressDialog(ctx);\n\n\t\tdialog.setProgressStyle(ProgressDialog.STYLE_HORIZONTAL);\n\t\tdialog.setMessage(ctx.getString(R.string.downloading_demo));\n\t\tdialog.setIndeterminate(false);\n\t\tdialog.setMax(100);\n\t\tdialog.setCancelable(false);\n\n\t\tfinal UnzipTask uzt = new Files.UnzipTask(extDir.getAbsolutePath()\n\t\t\t\t+ \"/demo/\") {\n\n\t\t\t@Override\n\t\t\tprotected void onPostExecute(AsyncTaskResult<String> result) {\n\t\t\t\tsuper.onPostExecute(result);\n\t\t\t\tdialog.hide();\n\n\t\t\t\tif (result.getResult() != null) {\n\t\t\t\t\tcustomLocation = result.getResult() + \"HOSP\";\n\t\t\t\t\tLog.d(getClass().getSimpleName(), \"Extracted TH demo: \"\n\t\t\t\t\t\t\t+ customLocation);\n\t\t\t\t} else if (result.getError() != null) {\n\t\t\t\t\tException e = result.getError();\n\t\t\t\t\tBugSenseHandler.sendException(e);\n\t\t\t\t\tDialogFactory.createFromException(result.getError(),\n\t\t\t\t\t\t\tctx.getString(R.string.download_demo_error), ctx,\n\t\t\t\t\t\t\tfalse).show();\n\t\t\t\t\tdownloadDemoRadio.setChecked(false);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t@Override\n\t\t\tprotected void onPreExecute() {\n\t\t\t\tsuper.onPreExecute();\n\t\t\t\tdialog.setMessage(ctx.getString(R.string.extracting_demo));\n\t\t\t}\n\n\t\t\t@Override\n\t\t\tprotected void onProgressUpdate(Integer... values) {\n\t\t\t\tsuper.onProgressUpdate(values);\n\t\t\t\tdialog.setProgress(values[0]);\n\t\t\t}\n\n\t\t};\n\n\t\tfinal DownloadFileTask dft = new Files.DownloadFileTask(\n\t\t\t\textDir.getAbsolutePath()) {\n\n\t\t\t@Override\n\t\t\tprotected void onPostExecute(AsyncTaskResult<File> result) {\n\t\t\t\tsuper.onPostExecute(result);\n\n\t\t\t\tif (result.getError() != null) {\n\t\t\t\t\tBugSenseHandler.sendException(result.getError());\n\t\t\t\t\tautomaticRadio.setChecked(true);\n\t\t\t\t\tdialog.hide();\n\n\t\t\t\t\tDialogFactory.createFromException(result.getError(),\n\t\t\t\t\t\t\tctx.getString(R.string.download_demo_error), ctx,\n\t\t\t\t\t\t\tfalse).show();\n\t\t\t\t} else {\n\t\t\t\t\tuzt.execute(result.getResult());\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t@Override\n\t\t\tprotected void onPreExecute() {\n\t\t\t\tsuper.onPreExecute();\n\t\t\t\tdialog.show();\n\t\t\t}\n\n\t\t\t@Override\n\t\t\tprotected void onProgressUpdate(Integer... values) {\n\t\t\t\tsuper.onProgressUpdate(values);\n\t\t\t\tdialog.setProgress(values[0]);\n\t\t\t}\n\n\t\t};\n\n\t\tdft.execute(ctx.getString(R.string.demo_url));\n\n\t}\n\n\tvoid doGameFilesSearch() {\n\t\tFindFilesTask fft = new FindFilesTask() {\n\n\t\t\tProgressDialog progressDialog;\n\n\t\t\t@Override\n\t\t\tprotected void onCancelled(AsyncTaskResult<String> result) {\n\t\t\t\tprogressDialog.hide();\n\t\t\t\tautomaticRadio.setChecked(false);\n\t\t\t\tToast.makeText(ctx, \"Search cancelled\", Toast.LENGTH_LONG)\n\t\t\t\t\t\t.show();\n\t\t\t}\n\n\t\t\t@Override\n\t\t\tprotected void onPostExecute(AsyncTaskResult<String> result) {\n\t\t\t\tsuper.onPostExecute(result);\n\n\t\t\t\tprogressDialog.hide();\n\t\t\t\tif (result.getResult() != null) {\n\t\t\t\t\tcustomLocation = result.getResult();\n\t\t\t\t\tToast.makeText(ctx, \"Found files in: \" + customLocation,\n\t\t\t\t\t\t\tToast.LENGTH_LONG).show();\n\t\t\t\t} else {\n\t\t\t\t\tautomaticRadio.setChecked(false);\n\t\t\t\t\tToast.makeText(\n\t\t\t\t\t\t\tctx,\n\t\t\t\t\t\t\t\"Couldn't find game files. Please set location manually or download the demo\",\n\t\t\t\t\t\t\tToast.LENGTH_LONG).show();\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t@Override\n\t\t\tprotected void onPreExecute() {\n\t\t\t\tsuper.onPreExecute();\n\n\t\t\t\tprogressDialog = new ProgressDialog(ctx);\n\t\t\t\tprogressDialog.setProgressStyle(ProgressDialog.STYLE_SPINNER);\n\t\t\t\tprogressDialog.setIndeterminate(true);\n\t\t\t\tprogressDialog.setMessage(\"Searching...\");\n\t\t\t\tprogressDialog.setCancelable(true);\n\t\t\t\tprogressDialog.show();\n\n\t\t\t}\n\n\t\t};\n\n\t\tfft.execute();\n\t}\n}\n"]],"start1":0,"start2":0,"length1":0,"length2":9278}]],"length":9278}
